<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device_width,height=device_height,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
	<title>2048</title>
	<style type="text/css">
	header{
		display: block;
		margin: 0 auto;
		width:500px;
		text-align: center;
		font-family: Arial;
	}
	header h1{
		font-size: 60px;
		font-weight: bold;
	}
	header #newgamebutton{
		display: block;
		margin: 20px auto;
		background-color: #8f7a66;
		width: 100px;
		border-radius: 10px;
		padding: 10px 10px;
		text-decoration: none;
	}
	header #newgamebutton:hover{
		background-color: #9f8b77;
	}
	header p{
		font-size: 25px;
		margin: 20px auto;
	}
	#grid_container{
		width: 460px;
		height: 460px;
		padding: 20px;

		margin: 50px auto;
		background: #bbada0;
		border-radius: 10px;
		position: relative;

	}
	#grid_container .grid-cell{
		width:100px;
		height: 100px;
		border-radius: 6px;
		background-color: #ccc0b3;
		position: absolute;
	}
	.number-cell{
		border-radius: 6px;
		font-family: Arial;
		font-weight: bold;
		font-size: 60px;
		line-height: 100px;
		text-align: center;
		position: absolute;
	}
	</style>
	<script type="text/javascript" src='jquery.js'></script>
</head>
<body>
	<header>
		<h1>2048</h1>
		<a href="javascript:newgame();" id='newgamebutton'>New Game</a>
		<p>score:<span id='score'>0</span></p>
	</header>
	<div id='grid_container'>
		<div class="grid-cell" id='grid-cell-0-0'></div>
		<div class="grid-cell" id='grid-cell-0-1'></div>
		<div class="grid-cell" id='grid-cell-0-2'></div>
		<div class="grid-cell" id='grid-cell-0-3'></div>
		<div class="grid-cell" id='grid-cell-1-0'></div>
		<div class="grid-cell" id='grid-cell-1-1'></div>
		<div class="grid-cell" id='grid-cell-1-2'></div>
		<div class="grid-cell" id='grid-cell-1-3'></div>
		<div class="grid-cell" id='grid-cell-2-0'></div>
		<div class="grid-cell" id='grid-cell-2-1'></div>
		<div class="grid-cell" id='grid-cell-2-2'></div>
		<div class="grid-cell" id='grid-cell-2-3'></div>
		<div class="grid-cell" id='grid-cell-3-0'></div>
		<div class="grid-cell" id='grid-cell-3-1'></div>
		<div class="grid-cell" id='grid-cell-3-2'></div>
		<div class="grid-cell" id='grid-cell-3-3'></div>
	</div>
<script type="text/javascript">
var board=[];
var score=0;
var hasConfilicted=[];
//main
	$(function(){
		newgame();
	});
	function newgame(){
		//初始化棋盘
		init();
		generateOneNumber();
		generateOneNumber();

	}
	function init(){
		//16个格子的位置
		for(var i=0;i<4;i++){
			for(var j=0;j<4;j++){
				var $gridCell=$("#grid-cell-"+i+"-"+j);
				$gridCell.css('top',getPosTop(i,j));
				$gridCell.css('left',getPosLeft(i,j));
			}
		}
		for(var i=0;i<4;i++){
			board[i]=[];
			hasConfilicted[i]=[];
			for(var j=0;j<4;j++){
				board[i][j]=0;
				hasConfilicted[i][j]=false;
			}
		}
		updateBoardView();
	}
	$(document).keydown(function(event){
		//console.log(event.keyCode);
		event.preventDefault();
		switch(event.keyCode){
			case 37://left
			if(moveLeft()){
				setTimeout("generateOneNumber()",210);
				setTimeout("isgameover()",300);
			}
			break;
			case 38://top
			if(moveTop()){
				setTimeout("generateOneNumber()",210);
				setTimeout("isgameover()",300);
			}
			break;
			case 39://right
			if(moveRight()){
				setTimeout("generateOneNumber()",210);
				setTimeout("isgameover()",300);
			}
			break;
			case 40://down
			if(moveDown()){
				setTimeout("generateOneNumber()",210);
				setTimeout("isgameover()",300);
			}
			break;
			default:break;
		}
	});
	//util
	function moveLeft(){
		if(!canMoveLeft(board)){
			return false;
		}
		for(var i=0;i<4;i++){
			for(var j=1;j<4;j++){
				if(board[i][j]!=0){
					for(var k=0;k<j;k++){
					if(board[i][k]==0&&noBlockHorizontal(i,k,j,board)){
						//move
						showMoveAnimation(i,j,i,k);
						board[i][k]=board[i][j];
						board[i][j]=0;
						continue;
					}
					else if(board[i][k]==board[i][j]&&noBlockHorizontal(i,k,j,board)&&!hasConfilicted[i][k]){
						//move
						showMoveAnimation(i,j,i,k);
						//merge
						board[i][k]+=board[i][j];
						board[i][j]=0;
						score+=board[i][k];
						updateScore();
						hasConfilicted[i][k]=true;
						continue;
					}
				}
				}

			}
		}
	    setTimeout("updateBoardView()",200);
		return true;
	}
	function moveRight(){
		//console.log("move right");
		if(!canMoveRight(board)){
			return false;
		}
		//console.log("move");
		for(var i=0;i<4;i++){
			for(var j=2;j>=0;j--){
				if(board[i][j]!=0){
					for(var k=3;k>j;k--){
					if(board[i][k]==0&&noBlockHorizontal(i,j,k,board)){
						//move
						showMoveAnimation(i,j,i,k);
						board[i][k]=board[i][j];
						board[i][j]=0;
						continue;
					}
					else if(board[i][k]==board[i][j]&&noBlockHorizontal(i,j,k,board)&&!hasConfilicted[i][k]){
						//move
						showMoveAnimation(i,j,i,k);
						//merge
						board[i][k]+=board[i][j];
						board[i][j]=0;
						score+=board[i][k];
						updateScore();
						hasConfilicted[i][k]=true;
						continue;
					}
				}
				}

			}
		}
	    setTimeout("updateBoardView()",200);
		return true;
	}
	function moveTop(){
		if(!canMoveTop(board)){
			return false;
		}
		for(var j=0;j<4;j++){
			for(var i=1;i<4;i++){
				if(board[i][j]!=0){
					for(var k=0;k<i;k++){
					if(board[k][j]==0&&noBlockVertical(j,k,i,board)){
						//move
						showMoveAnimation(i,j,k,j);
						board[k][j]=board[i][j];
						board[i][j]=0;
						continue;
					}
					else if(board[k][j]==board[i][j]&&noBlockVertical(j,k,i,board)&&!hasConfilicted[k][j]){
						//move
						showMoveAnimation(i,j,k,j);
						//merge
						board[k][j]+=board[i][j];
						board[i][j]=0;
						score+=board[k][j];
						updateScore();
						hasConfilicted[k][j]=true;
						continue;
					}
				}
				}

			}
		}
	    setTimeout("updateBoardView()",200);
		return true;
	}
	function moveDown(){
		if(!canMoveDown(board)){
			return false;
		}
		for(var j=0;j<4;j++){
			for(var i=2;i>=0;i--){
				if(board[i][j]!=0){
					for(var k=3;k>i;k--){
					if(board[k][j]==0&&noBlockVertical(j,i,k,board)){
						//move
						showMoveAnimation(i,j,k,j);
						board[k][j]=board[i][j];
						board[i][j]=0;
						continue;
					}
					else if(board[k][j]==board[i][j]&&noBlockVertical(j,i,k,board)&&!hasConfilicted[k][j]){
						//move
						showMoveAnimation(i,j,k,j);
						//merge
						board[k][j]+=board[i][j];
						board[i][j]=0;
						score+=board[k][j];
						updateScore();
						hasConfilicted[k][j]=true;
						continue;
					}
				}
				}

			}
		}
	    setTimeout("updateBoardView()",200);
		return true;
	}
	function updateScore(){
		$("#score").text(score);
	}
	function isgameover(){
		if(!canMoveDown(board)&&!canMoveLeft(board)&&!canMoveRight(board)&&!canMoveTop(board))
		{
			alert("game over");
		}
	}
	function showMoveAnimation(fromx,fromy,tox,toy){
		var numberCell=$("#number-cell-"+fromx+"-"+fromy);
		numberCell.animate({
			top:getPosTop(tox,toy)+"px",
			left:getPosLeft(tox,toy)+"px"
		},200);

	}
	function noBlockHorizontal(row,col1,col2,board){
		for(var i=col1+1;i<col2;i++){
			if(board[row][i]!=0){
				return false;
			}
		}
		return true;
	}
	function noBlockVertical(col,row1,row2,board){
		for(var i=row1+1;i<row2;i++){
			if(board[i][col]!=0){
				return false;
			}
		}
		return true;
	}
	function canMoveLeft(board){
		for(var i=0;i<4;i++){
			for(var j=1;j<4;j++){
				if(board[i][j]!=0){
					if(board[i][j-1]==0||board[i][j-1]==board[i][j]){
						return true;
					}
				}
			}
		}
		return false;
	}
	function canMoveRight(board){
		for(var i=0;i<4;i++){
			for(var j=3;j>=0;j--){
				if(board[i][j]!=0){
					if(board[i][j+1]==0||board[i][j+1]==board[i][j]){
						return true;
					}
				}
			}
		}
		return false;
	}
	function canMoveTop(board){
		for(var j=0;j<4;j++){
			for(var i=1;i<4;i++){
				if(board[i][j]!=0){
					if(board[i-1][j]==0||board[i-1][j]==board[i][j]){
						return true;
					}
				}
			}
		}
		return false;
	}
	function canMoveDown(board){
		for(var j=0;j<4;j++){
			for(var i=2;i>=0;i--){
				//console.log(i+"  "+j);
				if(board[i][j]!=0){
					if(board[i+1][j]==0||board[i+1][j]==board[i][j]){
						return true;
					}
				}
			}
		}
		return false;
	}

	function getPosTop(i,j){
		return 20+i*120;
	}
	function getPosLeft(i,j){
		return 20+j*120;
	}
	function updateBoardView(){
		$(".number-cell").remove();
		for(var i=0;i<4;i++){
			for(var j=0;j<4;j++){
				var id="number-cell-"+i+"-"+j;
				$("#grid_container").append('<div class="number-cell" id="'+id+'"></div>');
				var theNumberCell=$("#number-cell-"+i+"-"+j);
				if(board[i][j]==0){
					theNumberCell.css('width','0px');
					theNumberCell.css('height','0px');
					theNumberCell.css('top',getPosTop(i,j)+50);
					theNumberCell.css('left',getPosLeft(i,j)+50);

				}else{
					theNumberCell.css('width','100px');
					theNumberCell.css('height','100px');
					theNumberCell.css('top',getPosTop(i,j));
					theNumberCell.css('left',getPosLeft(i,j));
					theNumberCell.css('background-color',getNumberBgColor(board[i][j]));
					theNumberCell.css('color',getNumberColor(board[i][j]));
					theNumberCell.text(board[i][j]);
				}	
				hasConfilicted[i][j]=false;	
			}
		}
	}
	function getNumberBgColor(number){
		switch(number){
			case 2:return "#eee4da";
			case 4:return "#ede0c8";
			case 8:return "#f2b179";
			case 16:return "#f59563";
			case 32:return "#f69c5f";
			case 64:return "#f65e3b";
			case 128:return "#edc72";
			case 256:return "#edcc61";
			case 512:return "#9c0";
			case 1024:return "#33b5e5";
			case 2048:return "#09c";
			case 4096:return "#a6c";
			case 8192:return "#93c";

		}
	}
	function getNumberColor(number){
		if(number<=4){
			return "#776e65";
		}
		return "#fff";
	}
	function generateOneNumber(){
		//console.log(nospace(board));
		if(nospace(board)){
			return false;
		}
		var i=Math.floor(Math.random()*4);
		var j=Math.floor(Math.random()*4);
		while(true){
			if(board[i][j]==0){
				break;
			}
			else{
				 i=Math.floor(Math.random()*4);
		         j=Math.floor(Math.random()*4);
			}
		}
		//console.log(i+"  "+j);
		var n=Math.floor(Math.random()*2);
		n=n==0? 2:4;
		board[i][j]=n;
		showNumberWithAnimation(i,j,n);
		return true;
	}
	function nospace(board){
		for(var i=0;i<4;i++){
			for(var j=0;j<4;j++){
				if(board[i][j]==0){
					return false;
				}
			}
		}
		return true;
	}
	function showNumberWithAnimation(i,j,n){
		//console.log("shownumber   "+i+"  "+j);
		var numberCell=$("#number-cell-"+i+"-"+j);
		//console.log(numberCell);
		numberCell.css('background-color',getNumberBgColor(n));
		numberCell.css('color',getNumberColor(n));
		numberCell.text(n);
		numberCell.animate({
			width:"100px",
			height:"100px",
			top:getPosTop(i,j),
			left:getPosLeft(i,j)
		},50);
		
	}
</script>
</body>
</html>